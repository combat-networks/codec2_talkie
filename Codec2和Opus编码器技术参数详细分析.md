# Codec2 和 Opus 编码器技术参数详细分析

## 概述

本文档详细分析了 Codec2 和 Opus 两种音频编码器在不同码率条件下的技术参数，包括帧时间长度、帧长度（字节）、数据包结构等关键信息。

## 1. Codec2 编码器详细分析

### 1.1 基本特性
- **设计目标**: 低比特率语音通信，专为窄带语音设计
- **采样率**: 8000 Hz（窄带）
- **应用场景**: 低带宽、资源受限环境，如业余无线电、应急通信

### 1.2 支持的码率模式

| 模式名称 | 码率 (bps) | 帧时间长度 (ms) | 每帧采样数 | 每帧位数 | 每帧字节数 | 每秒帧数 |
|---------|-----------|----------------|-----------|---------|-----------|---------|
| MODE_450 | 450 | 20 | 160 | 18 | 3 | 50 |
| MODE_700C | 700 | 20 | 160 | 28 | 4 | 50 |
| MODE_1200 | 1200 | 20 | 160 | 48 | 6 | 50 |
| MODE_1300 | 1300 | 20 | 160 | 52 | 7 | 50 |
| MODE_1400 | 1400 | 20 | 160 | 56 | 7 | 50 |
| MODE_1600 | 1600 | 40 | 320 | 64 | 8 | 25 |
| MODE_2400 | 2400 | 20 | 160 | 48 | 6 | 50 |
| MODE_3200 | 3200 | 20 | 160 | 64 | 8 | 50 |

### 1.3 帧时间长度计算
```
帧时间长度 = 每帧采样数 / 采样率
例如：160 samples / 8000 Hz = 20 ms
```

### 1.4 数据包结构
- **单帧包**: 每个数据包通常包含一个语音帧
- **帧聚合**: 在某些应用中，可以将多个帧组合成一个数据包以提高传输效率
- **默认配置**: 项目中默认使用 MODE_450，每帧 3 字节，20ms 时长

## 2. Opus 编码器详细分析

### 2.1 基本特性
- **设计目标**: 高效、低延迟的音频编解码器
- **采样率**: 支持 8 kHz 到 48 kHz
- **应用场景**: 实时通信、流媒体、VoIP

### 2.2 支持的帧时间长度

| 帧时间长度 (ms) | 8kHz 采样数 | 48kHz 采样数 | 适用场景 |
|----------------|------------|-------------|---------|
| 2.5 | 20 | 120 | 极低延迟 |
| 5 | 40 | 240 | 低延迟 |
| 10 | 80 | 480 | 标准延迟 |
| 20 | 160 | 960 | 常用配置 |
| 40 | 320 | 1920 | 高延迟容忍 |
| 60 | 480 | 2880 | 批处理 |
| 80 | 640 | 3840 | 高延迟 |
| 100 | 800 | 4800 | 批处理 |
| 120 | 960 | 5760 | 最大延迟 |

### 2.3 码率与帧大小关系

#### 2.3.1 8kHz 采样率下的帧大小估算

| 码率 (kbps) | 20ms 帧大小 (字节) | 40ms 帧大小 (字节) | 60ms 帧大小 (字节) |
|------------|------------------|------------------|------------------|
| 6 | 15 | 30 | 45 |
| 8 | 20 | 40 | 60 |
| 12 | 30 | 60 | 90 |
| 16 | 40 | 80 | 120 |
| 24 | 60 | 120 | 180 |
| 32 | 80 | 160 | 240 |
| 48 | 120 | 240 | 360 |
| 64 | 160 | 320 | 480 |

#### 2.3.2 项目中的默认配置
- **默认码率**: 3200 bps (3.2 kbps)
- **默认帧时长**: 40 ms
- **计算帧大小**: 3200 bps × 40ms / 8 = 16 字节

### 2.4 数据包结构
- **单帧包**: 每个数据包包含一个编码帧
- **多帧包**: 支持将多个帧组合成一个数据包
- **最大包时长**: 120 ms
- **帧组合示例**:
  - 20ms 帧: 最多 6 帧/包 (6 × 20ms = 120ms)
  - 40ms 帧: 最多 3 帧/包 (3 × 40ms = 120ms)
  - 10ms 帧: 最多 12 帧/包 (12 × 10ms = 120ms)

## 3. 项目中的实际配置

### 3.1 Codec2 配置
```java
// 默认模式: MODE_450
String codec2ModeName = "MODE_450=10";
int codec2ModeId = 10; // CODEC2_MODE_450

// 帧参数
int samplesPerFrame = 160;  // 20ms @ 8kHz
int bitsPerFrame = 18;      // 2.25 字节
int frameDuration = 20;     // 毫秒
```

### 3.2 Opus 配置
```java
// 默认参数
int bitRate = 3200;         // 3.2 kbps
int complexity = 5;         // 复杂度 0-10
float frameDuration = 40.0f; // 40ms 帧时长

// 计算帧大小
int pcmFrameSize = (int)(8000 / 1000 * 40); // 320 samples
int encodedFrameSize ≈ 16; // 字节 (估算)
```

## 4. 性能对比分析

### 4.1 延迟对比
| 编码器 | 最小延迟 | 典型延迟 | 最大延迟 |
|--------|---------|---------|---------|
| Codec2 | 20ms | 20ms | 40ms |
| Opus | 2.5ms | 20ms | 120ms |

### 4.2 码率效率对比
| 码率范围 | Codec2 适用性 | Opus 适用性 |
|---------|-------------|------------|
| < 1 kbps | ✅ 优秀 | ❌ 不推荐 |
| 1-8 kbps | ✅ 良好 | ✅ 良好 |
| 8-64 kbps | ❌ 不适用 | ✅ 优秀 |
| > 64 kbps | ❌ 不适用 | ✅ 优秀 |

### 4.3 应用场景建议
- **Codec2**: 低带宽、应急通信、业余无线电
- **Opus**: 高质量语音、音乐、流媒体、VoIP

## 5. 实际使用建议

### 5.1 Codec2 使用建议
- 选择 MODE_450 用于最低带宽需求
- 选择 MODE_1200-1600 用于平衡质量和带宽
- 选择 MODE_3200 用于最佳语音质量

### 5.2 Opus 使用建议
- 低延迟应用: 2.5-10ms 帧时长
- 标准应用: 20ms 帧时长
- 高延迟容忍: 40-60ms 帧时长
- 批处理应用: 80-120ms 帧时长

## 6. 技术实现细节

### 6.1 帧时间长度计算
```
Codec2: 帧时长 = 采样数 / 8000 Hz
Opus: 帧时长 = 用户配置 (2.5-120ms)
```

### 6.2 帧大小计算
```
Codec2: 帧大小 = 码率 × 帧时长 / 8
Opus: 帧大小 = 码率 × 帧时长 / 8 (近似)
```

### 6.3 数据包结构
- **Codec2**: 通常单帧包，可配置聚合
- **Opus**: 支持单帧和多帧包，最大 120ms

## 结论

Codec2 和 Opus 各有优势：
- **Codec2** 在极低码率下表现优异，适合资源受限环境
- **Opus** 在宽码率范围内提供更好的质量和灵活性

选择编码器应根据具体应用场景、带宽限制、延迟要求和质量需求来决定。
