# æ¥æ”¶æ•°æ®åŒ…å®šæ—¶é€å…¥è§£ç å™¨çš„å®Œæ•´æµç¨‹

## ğŸ“¡ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æäº† Codec2 Talkie é¡¹ç›®ä¸­æ¥æ”¶æ•°æ®åŒ…ä»ç¯å½¢ç¼“å†²åŒºå®šæ—¶é€å…¥è§£ç å™¨çš„å®Œæ•´æµç¨‹ï¼ŒåŒ…æ‹¬å®šæ—¶æœºåˆ¶ã€ç¼“å†²åŒºç®¡ç†ã€è§£ç å™¨å¤„ç†ç­‰å…³é”®ç¯èŠ‚ã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### 1. æ ¸å¿ƒç»„ä»¶

```
AppWorker (ä¸»å·¥ä½œçº¿ç¨‹)
    â†“
Protocol (åè®®æ ˆ)
    â†“
KissBuffered (ç¼“å†²åè®®)
    â†“
AudioCodec2/AudioOpus (éŸ³é¢‘è§£ç å™¨)
    â†“
AudioTrack (éŸ³é¢‘è¾“å‡º)
```

### 2. å…³é”®å¸¸é‡

```java
// AppWorker.java
private static final int PROCESS_INTERVAL_MS = 10;        // 10ms å¤„ç†é—´éš”
private static final int LISTEN_AFTER_MS = 1500;         // 1.5ç§’ç›‘å¬å»¶è¿Ÿ

// KissBuffered.java
private static final int BUFFER_SIZE = 3200 * 60 * 10;   // 10åˆ†é’Ÿ@3200bpsç¼“å†²åŒº
private static final int GAP_TO_PLAY_MS = 1000;          // 1ç§’é™é»˜é—´éš”
```

## â° å®šæ—¶æœºåˆ¶è¯¦è§£

### 1. ä¸»å®šæ—¶å™¨ (AppWorker)

#### 1.1 å®šæ—¶å™¨åˆå§‹åŒ–
```java
// AppWorker.java:543-550
_processPeriodicTimer.schedule(new TimerTask() {
    @Override
    public void run() {
        Message msg = new Message();
        msg.what = AppMessage.CMD_PROCESS.toInt();
        _onMessageReceived.sendMessage(msg);
    }
}, 0, PROCESS_INTERVAL_MS);
```

**ç‰¹ç‚¹ï¼š**
- **å¤„ç†é¢‘ç‡**: 10ms é«˜é¢‘ç‡å¤„ç†
- **æ¶ˆæ¯é©±åŠ¨**: é€šè¿‡ Handler å‘é€ `CMD_PROCESS` æ¶ˆæ¯
- **çº¿ç¨‹ä¼˜å…ˆçº§**: `Process.THREAD_PRIORITY_URGENT_AUDIO`

#### 1.2 æ¶ˆæ¯å¤„ç†æœºåˆ¶
```java
// AppWorker.java:501-534
private void onWorkerIncomingMessage(Message msg) {
    switch (AppMessage.values()[msg.what]) {
        case CMD_PROCESS:
            try {
                processRxTx();  // æ ¸å¿ƒå¤„ç†é€»è¾‘
            } catch (IOException e) {
                e.printStackTrace();
                quitProcessing();
            }
            break;
        // ... å…¶ä»–æ¶ˆæ¯å¤„ç†
    }
}
```

### 2. æ¥æ”¶å¤„ç†æµç¨‹

#### 2.1 ä¸»å¤„ç†é€»è¾‘
```java
// AppWorker.java:480-492
private void processRxTx() throws IOException {
    processRecordPlaybackToggle();
    
    // å½•éŸ³çŠ¶æ€æ£€æŸ¥
    if (_systemAudioRecorder.getRecordingState() == AudioRecord.RECORDSTATE_RECORDING) {
        recordAndSendAudioFrame();
    } else {
        // æ’­æ”¾çŠ¶æ€ - æ¥æ”¶æ•°æ®
        if (_protocol.receive()) {
            sendStatusUpdate(AppMessage.EV_RECEIVING, null);
        }
    }
}
```

**å¤„ç†é€»è¾‘ï¼š**
1. **çŠ¶æ€æ£€æŸ¥**: åˆ¤æ–­å½“å‰æ˜¯å½•éŸ³è¿˜æ˜¯æ’­æ”¾çŠ¶æ€
2. **å½•éŸ³æ¨¡å¼**: å½•åˆ¶éŸ³é¢‘å¹¶å‘é€
3. **æ’­æ”¾æ¨¡å¼**: æ¥æ”¶æ•°æ®å¹¶å¤„ç†

## ğŸ—‚ï¸ ç¯å½¢ç¼“å†²åŒºç®¡ç†

### 1. KissBuffered ç¼“å†²ç­–ç•¥

#### 1.1 ç¼“å†²åŒºåˆå§‹åŒ–
```java
// KissBuffered.java:18-21
public KissBuffered() {
    super();
    _buffer = ByteBuffer.allocateDirect(BUFFER_SIZE);  // ç›´æ¥å†…å­˜åˆ†é…
}
```

**ç¼“å†²åŒºç‰¹ç‚¹ï¼š**
- **å¤§å°**: 10åˆ†é’Ÿ@3200bps æ•°æ®é‡
- **ç±»å‹**: ç›´æ¥å†…å­˜ç¼“å†²åŒº (é›¶æ‹·è´)
- **çº¿ç¨‹å®‰å…¨**: ä½¿ç”¨ `synchronized` ä¿æŠ¤

#### 1.2 æ•°æ®æ¥æ”¶ä¸ç¼“å†²
```java
// KissBuffered.java:39-62
@Override
protected void receiveKissData(byte[] data, ProtocolCallback protocolCallback) {
    // 1. å–æ¶ˆä¹‹å‰çš„å®šæ—¶å™¨
    try {
        if (_playbackTimer != null) {
            _playbackTimer.cancel();
            _playbackTimer.purge();
        }
    } catch (IllegalStateException ignored) {}
    
    // 2. æ•°æ®å­˜å…¥ç¯å½¢ç¼“å†²åŒº
    try {
        synchronized (_buffer) {
            _buffer.put(data);
        }
    } catch (BufferOverflowException e) {
        e.printStackTrace();
    }
    
    // 3. è®¾ç½®æ–°çš„å®šæ—¶å™¨ - 1ç§’åæ’­æ”¾
    _playbackTimer = new Timer();
    _playbackTimer.schedule(new TimerTask() {
        @Override
        public void run() {
            playBuffer(protocolCallback);
        }
    }, GAP_TO_PLAY_MS);  // 1000ms å»¶è¿Ÿ
}
```

**ç¼“å†²ç­–ç•¥ï¼š**
1. **æ•°æ®ç´¯ç§¯**: åœ¨é™é»˜æœŸé—´ç´¯ç§¯æ¥æ”¶çš„æ•°æ®åŒ…
2. **å®šæ—¶å™¨é‡ç½®**: æ¯æ¬¡æ–°æ•°æ®åˆ°è¾¾æ—¶é‡ç½®å®šæ—¶å™¨
3. **å»¶è¿Ÿæ’­æ”¾**: 1ç§’é™é»˜æœŸåä¸€æ¬¡æ€§æ’­æ”¾æ‰€æœ‰ç¼“å†²æ•°æ®

#### 1.3 ç¼“å†²åŒºæ’­æ”¾æœºåˆ¶
```java
// KissBuffered.java:23-37
private void playBuffer(ProtocolCallback protocolCallback) {
    synchronized (_buffer) {
        if (_buffer.position() > 0) {
            _buffer.flip();  // åˆ‡æ¢ä¸ºè¯»æ¨¡å¼
            try {
                byte[] b = new byte[_buffer.remaining()];
                _buffer.get(b);
                super.receiveKissData(b, protocolCallback);  // é€å…¥è§£ç å™¨
            } catch (BufferUnderflowException e) {
                e.printStackTrace();
            }
            _buffer.clear();  // æ¸…ç©ºç¼“å†²åŒº
        }
    }
}
```

**æ’­æ”¾ç‰¹ç‚¹ï¼š**
- **æ‰¹é‡å¤„ç†**: ä¸€æ¬¡æ€§å¤„ç†æ‰€æœ‰ç¼“å†²æ•°æ®
- **æ¨¡å¼åˆ‡æ¢**: `flip()` åˆ‡æ¢è¯»å†™æ¨¡å¼
- **é”™è¯¯å¤„ç†**: æ•è·ç¼“å†²åŒºä¸‹æº¢å¼‚å¸¸
- **èµ„æºæ¸…ç†**: æ’­æ”¾åæ¸…ç©ºç¼“å†²åŒº

## ğŸµ è§£ç å™¨å¤„ç†æµç¨‹

### 1. åè®®æ ˆæ¥æ”¶å¤„ç†

#### 1.1 åè®®æ¥æ”¶è°ƒç”¨
```java
// AppWorker.java:488-491
if (_protocol.receive()) {
    sendStatusUpdate(AppMessage.EV_RECEIVING, null);
}
```

#### 1.2 åè®®æ ˆå¤„ç†é“¾
```
KissBuffered â†’ Kiss â†’ Hdlc â†’ Ax25 â†’ AudioCodec2/AudioOpus
```

### 2. éŸ³é¢‘è§£ç å™¨å¤„ç†

#### 2.1 Codec2 è§£ç å™¨
```java
// AudioCodec2.java:95-99
protected void onReceiveCompressedAudio(String src, String dst, byte[] audioFrame) {
    Codec2.decode(_codec2Con, _playbackAudioBuffer, audioFrame);
    _parentProtocolCallback.onReceivePcmAudio(src, dst, _playbackAudioBuffer);
}
```

**Codec2 ç‰¹ç‚¹ï¼š**
- **ä½æ¯”ç‰¹ç‡**: é€‚åˆè¯­éŸ³é€šä¿¡
- **å®æ—¶æ€§**: ä½å»¶è¿Ÿè§£ç 
- **å‹ç¼©æ¯”**: é«˜å‹ç¼©æ¯”éŸ³é¢‘ç¼–ç 

#### 2.2 Opus è§£ç å™¨
```java
// AudioOpus.java:118-132
protected void onReceiveCompressedAudio(String src, String dst, byte[] audioEncodedFrame) {
    int decodedSamplesCnt = Opus.decode(_opusCon, audioEncodedFrame, _playbackAudioBuffer, _audioBufferSize);
    Log.v(TAG, "encoded frame size: " + audioEncodedFrame.length + ", decoded samples count:" + decodedSamplesCnt);
    
    if (decodedSamplesCnt == 0) {
        Log.w(TAG, "Nothing was decoded");
        return;
    }
    
    short[] decodedSamples = new short[decodedSamplesCnt];
    if (decodedSamplesCnt > 0) {
        System.arraycopy(_playbackAudioBuffer, 0, decodedSamples, 0, decodedSamplesCnt);
    } else {
        Log.e(TAG, "Decode error: " + decodedSamplesCnt);
        _parentProtocolCallback.onProtocolRxError();
    }
    _parentProtocolCallback.onReceivePcmAudio(src, dst, decodedSamples);
}
```

**Opus ç‰¹ç‚¹ï¼š**
- **é«˜è´¨é‡**: é«˜éŸ³è´¨éŸ³é¢‘ç¼–ç 
- **çµæ´»æ€§**: æ”¯æŒå¤šç§æ¯”ç‰¹ç‡
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„è§£ç é”™è¯¯å¤„ç†

### 3. éŸ³é¢‘å¸§èšåˆå™¨

#### 3.1 å¸§èšåˆå¤„ç†
```java
// AudioCodec2FrameAggregator.java:113-127
protected void onReceiveCompressedAudio(String src, String dst, byte[] audioFrames) {
    if (audioFrames.length % _codec2FrameSize != 0) {
        Log.e(TAG, "Ignoring audio frame of wrong size: " + audioFrames.length);
        _parentProtocolCallback.onProtocolRxError();
    } else {
        // æŒ‰å¸§å¤§å°åˆ†å‰²éŸ³é¢‘æ•°æ®
        byte[] audioFrame = new byte[_codec2FrameSize];
        for (int i = 0; i < audioFrames.length; i += _codec2FrameSize) {
            for (int j = 0; j < _codec2FrameSize && (j + i) < audioFrames.length; j++) {
                audioFrame[j] = audioFrames[i + j];
            }
            _parentProtocolCallback.onReceiveCompressedAudio(src, dst, audioFrame);
        }
    }
}
```

## ğŸ“Š å®Œæ•´æ•°æ®æµæ—¶åºå›¾

```
æ—¶é—´è½´: 0ms    10ms   20ms   30ms   ...   1000ms   1010ms   1020ms
        |       |      |      |           |        |        |
æ¥æ”¶æ•°æ®: [åŒ…1]  [åŒ…2]  [åŒ…3]  [åŒ…4]      [åŒ…N]    [åŒ…N+1]  [åŒ…N+2]
        |       |      |      |           |        |        |
ç¼“å†²åŒº:  ç´¯ç§¯    ç´¯ç§¯   ç´¯ç§¯   ç´¯ç§¯        ç´¯ç§¯      æ¸…ç©º     ç´¯ç§¯
        |       |      |      |           |        |        |
å®šæ—¶å™¨:  é‡ç½®    é‡ç½®   é‡ç½®   é‡ç½®        è§¦å‘     é‡ç½®     é‡ç½®
        |       |      |      |           |        |        |
è§£ç å™¨:  ç­‰å¾…    ç­‰å¾…   ç­‰å¾…   ç­‰å¾…        å¤„ç†     ç­‰å¾…     ç­‰å¾…
        |       |      |      |           |        |        |
éŸ³é¢‘è¾“å‡º: é™éŸ³   é™éŸ³   é™éŸ³   é™éŸ³        æ’­æ”¾     é™éŸ³     é™éŸ³
```

## ğŸ”„ å…³é”®è®¾è®¡æ¨¡å¼

### 1. åŒé‡å®šæ—¶æœºåˆ¶

#### 1.1 é«˜é¢‘å¤„ç†å®šæ—¶å™¨
- **é¢‘ç‡**: 10ms
- **ç”¨é€”**: æ£€æŸ¥æ¥æ”¶çŠ¶æ€
- **ä¼˜å…ˆçº§**: æœ€é«˜éŸ³é¢‘ä¼˜å…ˆçº§

#### 1.2 ç¼“å†²å»¶è¿Ÿå®šæ—¶å™¨
- **å»¶è¿Ÿ**: 1000ms
- **ç”¨é€”**: æ•°æ®ç´¯ç§¯å’Œæ‰¹é‡å¤„ç†
- **ä¼˜åŠ¿**: å‡å°‘è§£ç å™¨è°ƒç”¨æ¬¡æ•°

### 2. æ•°æ®æµæ§åˆ¶

#### 2.1 å®æ—¶æ€§ä¿è¯
```java
// 10ms é«˜é¢‘å¤„ç†ç¡®ä¿ä½å»¶è¿Ÿ
private static final int PROCESS_INTERVAL_MS = 10;
```

#### 2.2 è¿ç»­æ€§ä¿è¯
```java
// 1ç§’ç¼“å†²æœŸç¡®ä¿éŸ³é¢‘è¿ç»­æ€§
private static final int GAP_TO_PLAY_MS = 1000;
```

### 3. é”™è¯¯å¤„ç†æœºåˆ¶

#### 3.1 ç¼“å†²åŒºæº¢å‡ºå¤„ç†
```java
try {
    synchronized (_buffer) {
        _buffer.put(data);
    }
} catch (BufferOverflowException e) {
    e.printStackTrace();
}
```

#### 3.2 è§£ç é”™è¯¯å¤„ç†
```java
if (decodedSamplesCnt == 0) {
    Log.w(TAG, "Nothing was decoded");
    return;
}
```

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. å†…å­˜ç®¡ç†ä¼˜åŒ–

#### 1.1 ç›´æ¥å†…å­˜åˆ†é…
```java
_buffer = ByteBuffer.allocateDirect(BUFFER_SIZE);
```
- **é›¶æ‹·è´**: é¿å… JVM å †å†…å­˜æ‹·è´
- **æ€§èƒ½æå‡**: ç›´æ¥å†…å­˜è®¿é—®é€Ÿåº¦æ›´å¿«

#### 1.2 ç¼“å†²åŒºå¤ç”¨
```java
_buffer.clear();  // æ¸…ç©ºåå¤ç”¨
```

### 2. çº¿ç¨‹ä¼˜åŒ–

#### 2.1 å•çº¿ç¨‹å¤„ç†
- **é¿å…é”ç«äº‰**: å•çº¿ç¨‹å¤„ç†å‡å°‘åŒæ­¥å¼€é”€
- **ç¼“å­˜å‹å¥½**: æ•°æ®å±€éƒ¨æ€§æ›´å¥½

#### 2.2 é«˜ä¼˜å…ˆçº§çº¿ç¨‹
```java
android.os.Process.setThreadPriority(Process.THREAD_PRIORITY_URGENT_AUDIO);
```

### 3. æ¶ˆæ¯é©±åŠ¨ä¼˜åŒ–

#### 3.1 Handler æœºåˆ¶
```java
_onMessageReceived.sendMessage(msg);
```
- **å‡å°‘è½®è¯¢**: äº‹ä»¶é©±åŠ¨è€Œéè½®è¯¢
- **ç²¾ç¡®æ§åˆ¶**: æ¶ˆæ¯é˜Ÿåˆ—ç®¡ç†

## ğŸ› ï¸ è°ƒè¯•å’Œç›‘æ§

### 1. æ—¥å¿—è®°å½•

#### 1.1 å…³é”®èŠ‚ç‚¹æ—¥å¿—
```java
Log.v(TAG, "encoded frame size: " + audioEncodedFrame.length + ", decoded samples count:" + decodedSamplesCnt);
Log.w(TAG, "Nothing was decoded");
Log.e(TAG, "Decode error: " + decodedSamplesCnt);
```

#### 1.2 çŠ¶æ€æ›´æ–°
```java
sendStatusUpdate(AppMessage.EV_RECEIVING, null);
```

### 2. æ€§èƒ½ç›‘æ§

#### 2.1 ç¼“å†²åŒºçŠ¶æ€
- **ä½ç½®ç›‘æ§**: `_buffer.position()`
- **å®¹é‡ç›‘æ§**: `_buffer.capacity()`
- **å‰©ä½™ç©ºé—´**: `_buffer.remaining()`

#### 2.2 è§£ç æ€§èƒ½
- **è§£ç æ ·æœ¬æ•°**: `decodedSamplesCnt`
- **å¸§å¤§å°**: `audioEncodedFrame.length`
- **é”™è¯¯ç‡**: è§£ç å¤±è´¥ç»Ÿè®¡

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### 1. å»¶è¿ŸæŒ‡æ ‡
- **å¤„ç†å»¶è¿Ÿ**: < 10ms (å®šæ—¶å™¨é—´éš”)
- **ç¼“å†²å»¶è¿Ÿ**: 1000ms (é™é»˜æœŸ)
- **æ€»å»¶è¿Ÿ**: ~1010ms (åŒ…å«ç¼“å†²å»¶è¿Ÿ)

### 2. ååé‡æŒ‡æ ‡
- **ç¼“å†²åŒºå¤§å°**: 10åˆ†é’Ÿ@3200bps
- **å¤„ç†é¢‘ç‡**: 100Hz (10msé—´éš”)
- **å†…å­˜ä½¿ç”¨**: ç›´æ¥å†…å­˜åˆ†é…

### 3. å¯é æ€§æŒ‡æ ‡
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸æ•è·
- **èµ„æºç®¡ç†**: å®šæ—¶å™¨è‡ªåŠ¨æ¸…ç†
- **çŠ¶æ€åŒæ­¥**: çº¿ç¨‹å®‰å…¨ä¿æŠ¤

## ğŸ”§ é…ç½®å‚æ•°

### 1. å¯è°ƒå‚æ•°

```java
// å¤„ç†é—´éš” (æ¯«ç§’)
private static final int PROCESS_INTERVAL_MS = 10;

// ç¼“å†²å»¶è¿Ÿ (æ¯«ç§’)
private static final int GAP_TO_PLAY_MS = 1000;

// ç¼“å†²åŒºå¤§å° (å­—èŠ‚)
private static final int BUFFER_SIZE = 3200 * 60 * 10;
```

### 2. æ€§èƒ½è°ƒä¼˜å»ºè®®

#### 2.1 å»¶è¿Ÿä¼˜åŒ–
- **å‡å°‘ç¼“å†²å»¶è¿Ÿ**: é™ä½ `GAP_TO_PLAY_MS` å€¼
- **å¢åŠ å¤„ç†é¢‘ç‡**: é™ä½ `PROCESS_INTERVAL_MS` å€¼

#### 2.2 å†…å­˜ä¼˜åŒ–
- **è°ƒæ•´ç¼“å†²åŒºå¤§å°**: æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´ `BUFFER_SIZE`
- **ç›‘æ§å†…å­˜ä½¿ç”¨**: å®šæœŸæ£€æŸ¥ç¼“å†²åŒºçŠ¶æ€

## ğŸ“ æ€»ç»“

æ¥æ”¶æ•°æ®åŒ…å®šæ—¶é€å…¥è§£ç å™¨çš„å®Œæ•´æµç¨‹ä½“ç°äº†ä»¥ä¸‹è®¾è®¡ç‰¹ç‚¹ï¼š

1. **åŒé‡å®šæ—¶æœºåˆ¶**: é«˜é¢‘å¤„ç† + ç¼“å†²å»¶è¿Ÿ
2. **æ•°æ®æµæ§åˆ¶**: å®æ—¶æ€§ + è¿ç»­æ€§å¹³è¡¡
3. **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
4. **æ€§èƒ½ä¼˜åŒ–**: ç›´æ¥å†…å­˜ + å•çº¿ç¨‹å¤„ç†
5. **å¯é…ç½®æ€§**: å…³é”®å‚æ•°å¯è°ƒ

è¿™ç§è®¾è®¡ç¡®ä¿äº†éŸ³é¢‘æ•°æ®èƒ½å¤Ÿé«˜æ•ˆã€è¿ç»­åœ°å¤„ç†ï¼ŒåŒæ—¶ä¿æŒäº†è‰¯å¥½çš„å®æ—¶æ€§å’ŒéŸ³é¢‘è´¨é‡ã€‚
