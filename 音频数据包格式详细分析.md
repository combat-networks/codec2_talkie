# ğŸµ éŸ³é¢‘æ•°æ®åŒ…æ ¼å¼è¯¦ç»†åˆ†æ

## 1. éŸ³é¢‘æ•°æ®åŒ…å±‚æ¬¡ç»“æ„

```
PCM éŸ³é¢‘æ•°æ® (16ä½é‡‡æ ·)
    â†“
éŸ³é¢‘ç¼–ç å±‚ (Codec2/Opus)
    â†“
å‹ç¼©éŸ³é¢‘å¸§
    â†“
AX.25 éŸ³é¢‘æ•°æ®åŒ… (PID=0xF1)
    â†“
HDLC å¸§åŒæ­¥
    â†“
KISS åè®®ä¼ è¾“
```

## 2. Codec2 éŸ³é¢‘æ•°æ®åŒ…æ ¼å¼

### 2.1 Codec2 æ¨¡å¼å®šä¹‰
```java
// arrays.xml:21-30
<string-array name="codec2_modes">
    <item>MODE_450=10</item>      // 450 bps
    <item>MODE_700C=8</item>      // 700 bps
    <item>MODE_1200=5</item>      // 1200 bps
    <item>MODE_1300=4</item>      // 1300 bps
    <item>MODE_1400=3</item>      // 1400 bps
    <item>MODE_1600=2</item>      // 1600 bps
    <item>MODE_2400=1</item>      // 2400 bps
    <item>MODE_3200=0</item>      // 3200 bps
</string-array>
```

### 2.2 Codec2 å¸§ç»“æ„
```java
// AudioCodec2.java:183-194
private void constructCodec2(int codecMode) {
    _codec2Con = Codec2.create(codecMode);
    
    _audioBufferSize = Codec2.getSamplesPerFrame(_codec2Con);  // PCMæ ·æœ¬æ•°
    int codec2FrameSize = Codec2.getBitsSize(_codec2Con);      // ç¼–ç åå­—èŠ‚æ•°
    
    _recordAudioEncodedBuffer = new char[codec2FrameSize];    // ç¼–ç ç¼“å†²åŒº
    _playbackAudioBuffer = new short[_audioBufferSize];       // æ’­æ”¾ç¼“å†²åŒº
}
```

### 2.3 Codec2 ç¼–ç è¿‡ç¨‹
```java
// AudioCodec2.java:61-72
public void sendPcmAudio(String src, String dst, short[] pcmFrame) throws IOException {
    _parentProtocolCallback.onTransmitPcmAudio(src, dst, pcmFrame);
    
    // Codec2 ç¼–ç 
    Codec2.encode(_codec2Con, pcmFrame, _recordAudioEncodedBuffer);
    
    // è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„
    byte[] frame = new byte[_recordAudioEncodedBuffer.length];
    for (int i = 0; i < _recordAudioEncodedBuffer.length; i++) {
        frame[i] = (byte)_recordAudioEncodedBuffer[i];
    }
    _childProtocol.sendCompressedAudio(src, dst, frame);
}
```

### 2.4 Codec2 è§£ç è¿‡ç¨‹
```java
// AudioCodec2.java:96-99
protected void onReceiveCompressedAudio(String src, String dst, byte[] audioFrame) {
    Codec2.decode(_codec2Con, _playbackAudioBuffer, audioFrame);
    _parentProtocolCallback.onReceivePcmAudio(src, dst, _playbackAudioBuffer);
}
```

## 3. Opus éŸ³é¢‘æ•°æ®åŒ…æ ¼å¼

### 3.1 Opus é…ç½®å‚æ•°
```java
// AudioOpus.java:44-59
SharedPreferences sharedPreferences = PreferenceManager.getDefaultSharedPreferences(context);
int bitRate = Integer.parseInt(sharedPreferences.getString(PreferenceKeys.OPUS_BIT_RATE, "3200"));
int complexity = Integer.parseInt(sharedPreferences.getString(PreferenceKeys.OPUS_COMPLEXITY, "5"));
float pcmFrameDuration = Float.parseFloat(sharedPreferences.getString(PreferenceKeys.OPUS_FRAME_SIZE, "40"));

_pcmFrameSize = (int)(SAMPLE_RATE / 1000 * pcmFrameDuration);  // 8kHzé‡‡æ ·ç‡
_audioBufferSize = 10*_pcmFrameSize;

_opusCon = Opus.create(SAMPLE_RATE, 1, Opus.OPUS_APPLICATION_VOIP, bitRate, complexity);
```

### 3.2 Opus å¸§å¤§å°é€‰é¡¹
```java
// arrays.xml:32-42
<string-array name="opus_frame_size">
    <item>2.5</item>    // 2.5ms å¸§
    <item>5</item>      // 5ms å¸§
    <item>10</item>     // 10ms å¸§
    <item>20</item>     // 20ms å¸§
    <item>40</item>     // 40ms å¸§
    <item>60</item>     // 60ms å¸§
    <item>80</item>     // 80ms å¸§
    <item>100</item>    // 100ms å¸§
    <item>120</item>    // 120ms å¸§
</string-array>
```

### 3.3 Opus ç¼–ç è¿‡ç¨‹
```java
// AudioOpus.java:78-94
public void sendPcmAudio(String src, String dst, short[] pcmFrame) throws IOException {
    _parentProtocolCallback.onTransmitPcmAudio(src, dst, pcmFrame);
    
    // Opus ç¼–ç 
    int encodedBytesCnt = Opus.encode(_opusCon, pcmFrame, _pcmFrameSize, _recordAudioEncodedBuffer);
    
    if (encodedBytesCnt > 0) {
        byte[] frame = new byte[encodedBytesCnt];
        System.arraycopy(_recordAudioEncodedBuffer, 0, frame, 0, encodedBytesCnt);
        Log.v(TAG, "pcm count: " + pcmFrame.length + ", encoded bytes count: " + encodedBytesCnt);
        _childProtocol.sendCompressedAudio(src, dst, frame);
    } else {
        Log.e(TAG, "Encode error: " + encodedBytesCnt);
        _parentProtocolCallback.onProtocolTxError();
    }
}
```

### 3.4 Opus è§£ç è¿‡ç¨‹
```java
// AudioOpus.java:118-133
protected void onReceiveCompressedAudio(String src, String dst, byte[] audioEncodedFrame) {
    int decodedSamplesCnt = Opus.decode(_opusCon, audioEncodedFrame, _playbackAudioBuffer, _audioBufferSize);
    Log.v(TAG, "encoded frame size: " + audioEncodedFrame.length + ", decoded samples count:" + decodedSamplesCnt);
    
    if (decodedSamplesCnt > 0) {
        short[] decodedSamples = new short[decodedSamplesCnt];
        System.arraycopy(_playbackAudioBuffer, 0, decodedSamples, 0, decodedSamplesCnt);
        _parentProtocolCallback.onReceivePcmAudio(src, dst, decodedSamples);
    } else {
        Log.e(TAG, "Decode error: " + decodedSamplesCnt);
        _parentProtocolCallback.onProtocolRxError();
    }
}
```

## 4. éŸ³é¢‘å¸§èšåˆå™¨

### 4.1 å¸§èšåˆé€»è¾‘
```java
// AudioCodec2FrameAggregator.java:70-79
public void sendCompressedAudio(String src, String dst, byte[] frame) throws IOException {
    if (_outputBufferPos + frame.length > _outputBufferSize) {
        // ç¼“å†²åŒºæ»¡ï¼Œå‘é€èšåˆå¸§
        _childProtocol.sendCompressedAudio(src, dst, Arrays.copyOf(_outputBuffer, _outputBufferPos));
        _outputBufferPos = 0;
    }
    _lastSrc = src;
    _lastDst = dst;
    System.arraycopy(frame, 0, _outputBuffer, _outputBufferPos, frame.length);
    _outputBufferPos += frame.length;
}
```

### 4.2 å¸§åˆ†ç¦»é€»è¾‘
```java
// AudioCodec2FrameAggregator.java:113-127
protected void onReceiveCompressedAudio(String src, String dst, byte[] audioFrames) {
    if (audioFrames.length % _codec2FrameSize != 0) {
        Log.e(TAG, "Ignoring audio frame of wrong size: " + audioFrames.length);
        _parentProtocolCallback.onProtocolRxError();
    } else {
        // æŒ‰å¸§å¤§å°åˆ†ç¦»éŸ³é¢‘å¸§
        byte[] audioFrame = new byte[_codec2FrameSize];
        for (int i = 0; i < audioFrames.length; i += _codec2FrameSize) {
            for (int j = 0; j < _codec2FrameSize && (j + i) < audioFrames.length; j++) {
                audioFrame[j] = audioFrames[i + j];
            }
            _parentProtocolCallback.onReceiveCompressedAudio(src, dst, audioFrame);
        }
    }
}
```

## 5. AX.25 éŸ³é¢‘æ•°æ®åŒ…æ ¼å¼

### 5.1 éŸ³é¢‘æ•°æ®åŒ…æ ‡è¯†
```java
// AX25Packet.java:26-28
private final byte AX25CTRL_UI = (byte)0x03;        // UI å¸§
private final byte AX25PID_NO_LAYER3 = (byte)0xf0;   // ééŸ³é¢‘æ•°æ®
private final byte AX25PID_AUDIO = (byte)0xf1;       // éŸ³é¢‘æ•°æ®
```

### 5.2 éŸ³é¢‘æ•°æ®åŒ…ç»“æ„
```
| ç›®æ ‡åœ°å€ | æºåœ°å€ | ä¸­ç»§è·¯å¾„ | æ§åˆ¶ | PID | éŸ³é¢‘æ•°æ® |
| 7å­—èŠ‚   | 7å­—èŠ‚  | 7å­—èŠ‚Ã—N | 0x03 |0xF1 | å˜é•¿     |
```

### 5.3 éŸ³é¢‘æ•°æ®åŒ…è¯†åˆ«
```java
// AX25Packet.java:82-90
byte ax25Pid = buffer.get();
if (ax25Pid == AX25PID_AUDIO) {
    isAudio = true;                    // æ ‡è®°ä¸ºéŸ³é¢‘æ•°æ®
} else if (ax25Pid == AX25PID_NO_LAYER3) {
    isAudio = false;                   // æ ‡è®°ä¸ºééŸ³é¢‘æ•°æ®
} else {
    return;                           // æ— æ•ˆPID
}
```

## 6. éŸ³é¢‘æ•°æ®åŒ…å¤„ç†æµç¨‹

### 6.1 å‘é€æµç¨‹
```
PCM éŸ³é¢‘è¾“å…¥ (16ä½é‡‡æ ·)
    â†“
éŸ³é¢‘ç¼–ç  (Codec2/Opus)
    â†“
å‹ç¼©éŸ³é¢‘å¸§
    â†“
å¸§èšåˆ (å¯é€‰)
    â†“
AX.25 éŸ³é¢‘åŒ… (PID=0xF1)
    â†“
HDLC å¸§åŒæ­¥
    â†“
KISS åè®®ä¼ è¾“
```

### 6.2 æ¥æ”¶æµç¨‹
```
KISS åè®®æ¥æ”¶
    â†“
HDLC å¸§åŒæ­¥
    â†“
AX.25 åŒ…è§£æ (PID=0xF1)
    â†“
å¸§åˆ†ç¦» (å¯é€‰)
    â†“
éŸ³é¢‘è§£ç  (Codec2/Opus)
    â†“
PCM éŸ³é¢‘è¾“å‡º
```

## 7. éŸ³é¢‘æ•°æ®åŒ…æŠ€æœ¯å‚æ•°

### 7.1 Codec2 æŠ€æœ¯å‚æ•°
```java
// ä¸åŒæ¨¡å¼çš„å¸§å¤§å°å’Œæ¯”ç‰¹ç‡
MODE_3200: 8å­—èŠ‚/å¸§,  20ms, 3200 bps
MODE_2400: 6å­—èŠ‚/å¸§,  20ms, 2400 bps  
MODE_1600: 4å­—èŠ‚/å¸§,  20ms, 1600 bps
MODE_1400: 3.5å­—èŠ‚/å¸§, 20ms, 1400 bps
MODE_1300: 3.25å­—èŠ‚/å¸§, 20ms, 1300 bps
MODE_1200: 3å­—èŠ‚/å¸§,  20ms, 1200 bps
MODE_700C: 1.75å­—èŠ‚/å¸§, 20ms, 700 bps
MODE_450:  1.125å­—èŠ‚/å¸§, 20ms, 450 bps
```

### 7.2 Opus æŠ€æœ¯å‚æ•°
```java
// å¯é…ç½®å‚æ•°
é‡‡æ ·ç‡: 8000 Hz
å£°é“æ•°: 1 (å•å£°é“)
åº”ç”¨ç±»å‹: VOIP
æ¯”ç‰¹ç‡: 2400-512000 bps
å¤æ‚åº¦: 0-10
å¸§é•¿åº¦: 2.5-120ms
```

## 8. éŸ³é¢‘æ•°æ®åŒ…ç¼“å†²åŒºç®¡ç†

### 8.1 å‘é€ç¼“å†²åŒº
```java
// AudioCodec2FrameAggregator.java:26-28
private int _outputBufferSize;        // æœ€å¤§èšåˆå¸§å¤§å°
private int _outputBufferPos;         // å½“å‰ç¼“å†²åŒºä½ç½®
private byte[] _outputBuffer;        // è¾“å‡ºç¼“å†²åŒº
```

### 8.2 æ¥æ”¶ç¼“å†²åŒº
```java
// AudioCodec2.java:23-24
private char[] _recordAudioEncodedBuffer;  // ç¼–ç ç¼“å†²åŒº
private short[] _playbackAudioBuffer;     // æ’­æ”¾ç¼“å†²åŒº
```

## 9. éŸ³é¢‘æ•°æ®åŒ…é”™è¯¯å¤„ç†

### 9.1 ç¼–ç é”™è¯¯
```java
// AudioOpus.java:91-93
if (encodedBytesCnt < 0) {
    Log.e(TAG, "Encode error: " + encodedBytesCnt);
    _parentProtocolCallback.onProtocolTxError();
}
```

### 9.2 è§£ç é”™è¯¯
```java
// AudioOpus.java:128-131
if (decodedSamplesCnt < 0) {
    Log.e(TAG, "Decode error: " + decodedSamplesCnt);
    _parentProtocolCallback.onProtocolRxError();
}
```

### 9.3 å¸§å¤§å°é”™è¯¯
```java
// AudioCodec2FrameAggregator.java:114-117
if (audioFrames.length % _codec2FrameSize != 0) {
    Log.e(TAG, "Ignoring audio frame of wrong size: " + audioFrames.length);
    _parentProtocolCallback.onProtocolRxError();
}
```

## 10. éŸ³é¢‘æ•°æ®åŒ…æ€§èƒ½ä¼˜åŒ–

### 10.1 å¸§èšåˆä¼˜åŒ–
```java
// é»˜è®¤æœ€å¤§èšåˆå¸§å¤§å°: 48å­—èŠ‚
_outputBufferSize = Integer.parseInt(sharedPreferences.getString(
    PreferenceKeys.CODEC2_TX_FRAME_MAX_SIZE, "48"));
```

### 10.2 ç¼“å†²åŒºå¤§å°ä¼˜åŒ–
```java
// AudioOpus.java:49-50
_pcmFrameSize = (int)(SAMPLE_RATE / 1000 * pcmFrameDuration);
_audioBufferSize = 10*_pcmFrameSize;  // 10å€å¸§å¤§å°ä½œä¸ºç¼“å†²åŒº
```

## 11. éŸ³é¢‘æ•°æ®åŒ…æ ¼å¼æ€»ç»“

### 11.1 æ”¯æŒçš„ç¼–ç æ ¼å¼
- **Codec2**: ä¸“ä¸ºä¸šä½™æ— çº¿ç”µä¼˜åŒ–çš„ä½æ¯”ç‰¹ç‡è¯­éŸ³ç¼–ç 
- **Opus**: é€šç”¨éŸ³é¢‘ç¼–ç ï¼Œæ”¯æŒå¯å˜æ¯”ç‰¹ç‡

### 11.2 ä¼ è¾“åè®®
- **AX.25**: ä¸šä½™æ— çº¿ç”µæ•°æ®é“¾è·¯åè®®
- **HDLC**: é«˜çº§æ•°æ®é“¾è·¯æ§åˆ¶åè®®
- **KISS**: ç®€å•ä¸²è¡Œåè®®

### 11.3 å…³é”®ç‰¹æ€§
- **å¸§èšåˆ**: æé«˜ä¼ è¾“æ•ˆç‡
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯æ£€æµ‹å’Œæ¢å¤æœºåˆ¶
- **ç¼“å†²åŒºç®¡ç†**: ä¼˜åŒ–çš„å†…å­˜ä½¿ç”¨
- **å®æ—¶å¤„ç†**: ä½å»¶è¿ŸéŸ³é¢‘ä¼ è¾“

è¿™ä¸ªéŸ³é¢‘æ•°æ®åŒ…æ ¼å¼è®¾è®¡æ”¯æŒä¸¤ç§ä¸»è¦çš„éŸ³é¢‘ç¼–ç æ ‡å‡†ï¼šCodec2ï¼ˆä¸“ä¸ºä¸šä½™æ— çº¿ç”µä¼˜åŒ–ï¼‰å’ŒOpusï¼ˆé€šç”¨éŸ³é¢‘ç¼–ç ï¼‰ï¼Œé€šè¿‡AX.25åè®®è¿›è¡Œä¼ è¾“ï¼Œç¡®ä¿äº†éŸ³é¢‘æ•°æ®åœ¨ä¸šä½™æ— çº¿ç”µç½‘ç»œä¸­çš„å¯é ä¼ è¾“ã€‚
